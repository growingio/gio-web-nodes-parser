import e from"array-from";var t=function(){return t=Object.assign||function(e){for(var t,n=1,i=arguments.length;i>n;n++)for(var r in t=arguments[n])({}).hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},t.apply(this,arguments)};function n(e,t,n){if(n||2===arguments.length)for(var i,r=0,o=t.length;o>r;r++)!i&&r in t||(i||(i=[].slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||[].slice.call(t))}var i=function(e){try{return e()}catch(e){return}},r=function(e){return"number"===f(e)},o=function(e){return"object"===f(e)&&!function(e){return c(["undefined","null"],f(e))}(e)},a=function(e){return Array.isArray(e)&&"array"===f(e)},u=function(e,t){var n=-1;if(a(e))for(var i=0;i<e.length;i++)if(t(e[i]))return i;return n},c=function(e,t){return("array"===f(e)||"string"===f(e))&&e.indexOf(t)>=0},s=e,l=function(e){return a(e)?0===e.length:o(e)?0===function(e){return o(e)?Object.keys(e):[]}(e).length:!e},d=function(e){if(a(e)){for(var t=0,n=[],i=0,r=e;i<r.length;i++){var o=r[i];o&&!l(o)&&(n[t++]=o)}return n}return e},f=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},g=["body","br","canvas","clippath","defs","desc","g","hr","html","iframe","math","param","path","rect","script","style","text","title","tspan","use"],h=["button","reset","submit"],v=n(n([],h,!0),["file"],!1),m=["checkbox","color","radio","range"],p=n(n([],m,!0),["date","datetime-local","month","number","password","text","time","week"],!1),N=["tr","li","dt","dd"],w=n(["a","button","dl"],N,!0),b=["i","em","svg","img"],L=["i","span","em","b","strong","bdo"],E=/(^| |[^ ]+\-)(clear|clearfix|active|hover|enabled|current|selected|unselected|hidden|display|focus|disabled|undisabled|open|checked|unchecked|undefined|null|ng-|growing-)[^\. ]*/g,_=/^([a-zA-Z\-\_0-9]+)$/,y="data-growing-ignore",x="data-growing-container",I="data-growing-index",k="data-growing-title",C=function(e,t){var n;return null!==(n=i((function(){return e.hasAttribute(t)&&"false"!==e.getAttribute(t)})))&&void 0!==n?n:i((function(){return e.hasOwnPerporty(t)}))},T=function(e,t){var n;return null!==(n=i((function(){return e.getAttribute(t)})))&&void 0!==n?n:i((function(){return e.attributes[t].value}))},O=function(e){var t,n=!c(g,e.tagName.toLowerCase()),i=X(e);return n&&i&&c(L,null===(t=e.tagName)||void 0===t?void 0:t.toLowerCase())?O(i):e},P=function(e,t,n){if(void 0===t&&(t=5),void 0===n&&(n=0),!e.children)return!1;if("svg"===e.tagName.toLocaleLowerCase())return n>t;if(n>t)return!0;for(var i=0;i<e.children.length;i++){var r=e.children[i];if(P(r,t,n+1))return!0}return!1},H=function(e,t){return void 0===t&&(t=!1),s((null==e?void 0:e.childNodes)||[]).filter((function(e){return c(t?[Node.ELEMENT_NODE,Node.TEXT_NODE]:[Node.ELEMENT_NODE],e.nodeType)}))},X=function(e){return S(e.parentElement)?null:e.parentElement},S=function(e){return!e||c(["BODY","HTML","#document"],e.tagName)},W=function(e){var t=H(e);return!l(t)&&t.every((function(e){var t=z(e),n=c(e.classList,"icon");return!(!t&&!n||j(e))}))},j=function(e){var t=H(e,!0);return!l(t)&&t.every((function(e){var t=e.nodeType===Node.TEXT_NODE,n=V(e);return!(!t||!n)}))},z=function(e){return c(b,e.tagName.toLocaleLowerCase())},V=function(e){var t=H(e,!0).filter((function(e){var t;return e.nodeType===Node.TEXT_NODE||c(L,null===(t=e.tagName)||void 0===t?void 0:t.toLowerCase())})).map((function(e){return A(e.textContent,e.textContent.length)}));return d(t).join(" ")},A=function(e,t){return void 0===t&&(t=50),e&&(null==(e=e.replace(/[\n \t]+/g," ").trim())?void 0:e.length)?e.slice(0,r(t)&&t>0?t:void 0):""},G=/[^/]*.(bmp|jpg|jpeg|png|gif|svg|psd|webp|apng)/gi,D=function(e,t){switch(t){case"a":return function(e){if(C(e,"href")){var t=T(e,"href");if(t&&0!==t.indexOf("javascript"))return t.slice(0,320)}return""}(e);case"img":return function(e){var t=e.src;if(t&&-1===t.indexOf("data:image")){var n=t.match(G),i=l(n)?"":n[0];if(i.indexOf("%")>-1){var r=function(e,t){var n=-1;if(a(e))for(var i=0;i<e.length;i++)"%"===e[i]&&(n=i);return n}(i.split(""));i=i.substring(r+3,i.length)}return i}return""}(e);default:return""}},F={a:function(e){var t=V(e);return t||(B(e)||D(e,"a"))},button:function(e){var t=T(e,"name");if(t)return t;var n=V(e);return n||(B(e)||R(e))},img:function(e){return A(T(e,"alt"))||D(e,"img")},input:function(e){if("password"===e.type)return"";var t,n,i=e instanceof HTMLInputElement&&c(v,e.type),r=C(e,"data-growing-track");if(i||r)return A(e.value);if(e instanceof HTMLInputElement&&c(m,e.type)){var o=void 0;if(e.id)n=function(t){return t.htmlFor===e.id},o=(t=s(document.getElementsByTagName("label")))[u(t,n)];else o=Z(e,(function(e){return"label"===e.tagName.toLowerCase()}));return U(e,o?V(o):A(e.value))}return""},label:function(e){var t=V(e);return t||(B(e)||R(e))},select:function(e){return A(s(e.options).filter((function(e){return e.selected})).map((function(e){return e.label})).join(", ")||e.value)},svg:function(e){var t;return H(e).some((function(e){var n;if(e.nodeType===Node.ELEMENT_NODE&&"use"===(null===(n=e.tagName)||void 0===n?void 0:n.toLowerCase())&&e.hasAttribute("xlink:href"))return t=e,!0})),t?t.getAttribute("xlink:href"):""},textarea:function(){return""},form:function(){return""}},M=function(e,t){if(C(e,k)&&T(e,k))return A(T(e,k));if(C(e,"title")&&T(e,"title"))return A(T(e,"title"));var n=F[t];if(n)return n(e);var i=V(e);return i?A(i):function(e){if("svg"===e.tagName)return!1;var t=H(e);return t.length>0&&t.every((function(e){return function(e){if("svg"===e.tagName)return!0;var t=H(e);if(l(t))return!0;var n=j(e);return!(!l(t)&&!n)}(e)}))}(e)&&!W(e)?A(B(e)):W(e)?A(R(e)):""},Z=function(e,t){for(var n=e.parentElement;n&&!S(n);){if(t(n))return n;n=n.parentElement}},B=function(e){var t=H(e);return d(t.map((function(e){var t=V(e);if(j(e)&&t)return t}))).join(" ")},R=function(e){var t;return H(e).some((function(e){var n,i=M(e,null===(n=e.tagName)||void 0===n?void 0:n.toLowerCase());return!!i&&(t=i,!0)})),t},U=function(e,t){return c(["checkbox","radio"],e.type)?"".concat(t).concat((n=e.checked,"boolean"===f(n)?"("+e.checked+")":"")):t;var n},$=function e(t,r){var o=this;this.originNode=t,this.deviceInfo=r,this._getIndex=function(){if(C(o.originNode,I)){var e=T(o.originNode,I);return/^\d{1,10}$/.test(e)&&+e>=0&&2147483647>+e?+e:("warn",void console.log("%c [GrowingIO]：".concat("".concat(e,"，index标记应为 大于等于 0 且小于 2147483647 的整数！")),"color: #F59E0B;"))}if(c(["dd","dt"],o.tagName)){var t=X(o.originNode),i=t?H(t):[];if("dl"===t.tagName.toLowerCase()&&i.length>0){if("dd"===o.tagName){var r=u(i,(function(e){return e.isSameNode(o.originNode)}));if(r>-1)return(a=i.slice(0,r).filter((function(e){return"dt"===e.tagName.toLowerCase()}))).length-1}if("dt"===o.tagName){var a=i.filter((function(e){return"dt"===e.tagName.toLowerCase()}));return u(a,(function(e){return e.isSameNode(o.originNode)}))}}}if(o.isPureList){var s=u(o._pureList,(function(e){return e.isSameNode(o.originNode)}));return s>-1?(o.peerNodes=n([],o._pureList,!0),o.peerNodes.splice(s,1),s+1):void 0}if(o.isPseudoList){var l=u(o._pseudoList,(function(e){return e.isSameNode(o.originNode)}));return l>-1?(o.peerNodes=n([],o._pseudoList,!0),o.peerNodes.splice(l,1),l+1):void 0}},this._getSiblingNode=function(e,t){var n,r=X(e);if(!r)return[];for(var o=null!==(n=i((function(){return s(r.children)})))&&void 0!==n?n:[],a=[],u=0;u<o.length;u++){var c=o[u],d=o[u+1];if(!d||!t(c,d))break;l(a)?a.push(c,d):a.push(d)}return a},this._getIsPureList=function(){var e=o._getSiblingNode(o.originNode,(function(e,t){return e.tagName===t.tagName}));return!(1>e.length||!c(N,o.tagName)||(o._pureList=e,0))},this._getIsInPseudoList=function(){if(c(["th","td"],o.tagName))return!1;var e=o._getSiblingNode(o.originNode,(function(e,t){var n=e.tagName===t.tagName&&e.className===t.className,i=H(e),r=H(t),o=i.every((function(e,t){var n,i;return(null==e?void 0:e.tagName)===(null===(n=r[t])||void 0===n?void 0:n.tagName)&&(null==e?void 0:e.className)===(null===(i=r[t])||void 0===i?void 0:i.className)})),a=i.length===r.length&&o;return n&&a}));return e.length>=3&&(o._pseudoList=e,!0)},this._getClassList=function(e){var t;if(C(e,"name")&&T(e,"name"))return[T(e,"name")];var n=(null!==(t=T(e,"class"))&&void 0!==t?t:"").trim().split(" ");return l(n)?[]:n.filter((function(e){return e&&!E.test(e)&&_.test(e)})).sort()},this._getCurrentXpath=function(){return"/".concat(o.tagName).concat(o.id?"#"+o.id:"").concat(l(o.classList)?"":"."+o.classList.join("."))},this._getIsContainer=function(){return C(o.originNode,x)||c(w,o.tagName)||"input"===o.tagName&&c(h,o.originNode.type)},this._getContent=function(){o.content=M(o.originNode,o.tagName)},this._getIsOutFlow=function(){var e=window.getComputedStyle(o.originNode).position;return c(["fixed","sticky"],e)},this._getIsVisible=function(){var e=window.getComputedStyle(o.originNode),t=e.opacity,n=e.visibility,i=e.display;return Number(t)>0&&"hidden"!==n&&"none"!==i&&(o.originNode.clientHeight>0||o.originNode.clientWidth>0)},this._getRect=function(){var e=o.originNode.getBoundingClientRect(),t=e.top,n=e.bottom,i=e.left,r=e.right-i,a=n-t;return t+a>o.deviceInfo.winHeight&&(a=o.deviceInfo.winHeight-t),i+r>o.deviceInfo.winWidth&&(r=o.deviceInfo.winWidth-i),{top:t,left:i,width:r,height:a}},this._getViewStatus=function(){var e=o.rect,t=e.top,n=e.left,i=e.width,r=e.height,a=o.deviceInfo,u=a.winWidth,c=function(e,t){return document.elementFromPoint(e,t)===o.originNode};return a.winHeight>t&&u>n&&i>0&&r>0?c(n+i/2,t+r/2)||c(n+1,t+1)||c(n+i-1,t+1)||c(n+1,t+r-1)||c(n+i-1,t+r-1)?"IN_SHOW":"IN_COVERED":"OUT"},this._getTriggerEvent=function(){return"input"===o.tagName&&c(p,o.originNode.type)||c(["select","textarea"],o.tagName)?"VIEW_CHANGE":"VIEW_CLICK"},this._getXParents=function(t){for(var n=t.parentElement,i=[];n&&!S(n);)i.push(new e(n)),n=n.parentElement;return i},this.tagName=t.tagName.toLocaleLowerCase(),this.isPureList=this._getIsPureList(),this.isPseudoList=this._getIsInPseudoList(),this.isContainer=this._getIsContainer(),this.classList=this._getClassList(t),this.xParents=this._getXParents(t),this.index=this._getIndex(),this.id=t.id,this.triggerEvent=this._getTriggerEvent(),this.hyperlink=D(t,this.tagName),this.currentXpath=this._getCurrentXpath(),this.isIgnored=C(this.originNode,y),this.content=M(this.originNode,this.tagName),this.isOutFlow=this._getIsOutFlow(),this.isVisible=this._getIsVisible(),r&&(this.rect=this._getRect(),this.viewStatus=this._getViewStatus())},K=function e(t,i,o,a){var u=this;this.origin=t,this.action=i,this.lengthThreshold=o,this.deviceInfo=a,this.trackable=function(){var e=u.originElement.tagName.toLowerCase();if(!(u.originElement instanceof Element))return!1;if(C(u.originElement,y))return!1;if(c(g,e))return!1;if(c(["circleClick","circleHover","click"],u.actionType)){if("textarea"===e&&"click"===u.actionType)return!1;if("input"===e){if("click"===u.actionType&&!c(v,T(u.originElement,"type")))return!1;if(c(["circleClick","circleHover"],u.actionType)&&!c(n(n([],v,!0),p,!0),T(u.originElement,"type")))return!1}if(!u.xNode.isContainer&&P(u.originElement,5))return!1}return!0},this.trackNodes=function(){if(!u.trackable())return[];var e=[u.xNode];if(c(["click","circleClick","change"],u.actionType))for(var t=u._getParent();t;){if(t.xNode.isIgnored)return[];t.trackable()&&e.push(t.xNode),t=t._getParent()}var n,i=[];return e.reverse().forEach((function(t,o){if(C(t.originNode,x)&&(i=[],n=void 0),r(t.index)&&!r(n)&&(n=t.index),r(n)&&(t.index=n),o===e.length-1)i.push(u.getGioNodeInfo(t));else{var a=t.isPureList||t.isPseudoList;(t.isContainer||a)&&i.push(u.getGioNodeInfo(t))}})),i},this.getGioNodeInfo=function(e){var t=u.computeXpath(e),n=t.skeleton,i=t.fullXpath,r=t.xpath,o=t.xcontent,a=e.hyperlink,c=e.index,s=e.peerNodes;return{skeleton:n,fullXpath:i,xpath:r,xcontent:o,hyperlink:a,index:c,peerNodes:null!=s?s:[],content:e.content,outFlow:e.isOutFlow,triggerEvent:e.triggerEvent,originNode:e.originNode}},this.computeXpath=function(e){var t,n="/"+e.tagName,i=e.currentXpath,r=e.currentXpath,o="/"+((e.id?"#"+e.id:"")+(l(e.classList)?"":"."+e.classList.join("."))||"-");return null===(t=e.xParents)||void 0===t||t.forEach((function(e,t){if(i=e.currentXpath+i,t<u.xpathThreshold-1){n="/"+e.tagName+n,r=e.currentXpath+r;var a=(e.id?"#"+e.id:"")+(l(e.classList)?"":"."+e.classList.join("."));o="/"+(a||"-")+o}})),{skeleton:n,fullXpath:i,xpath:r,xcontent:o}},this._getParent=function(){var t=X(u.originElement);if(t&&t.nodeName&&!S(t))return new e(t,u.actionType)},this.actionType=c(["circleClick","circleHover","click","change"],i)?i:"click",this.originElement=O(t),this.xpathThreshold=r(o)?o:4,this.originElement&&(this.xNode=new $(this.originElement,this.deviceInfo))},Y=[],q=function(e,n){var i,r,o,a,u,c,d,f=this;this.trackNodes=function(e,t){return Y=[],f._getTrackElements(e,t),Y},this._getTrackElements=function(e,t){H(e).forEach((function(e){var n=new K(e,"circleClick",f.xpathThreshold,f.deviceInfo),i=n.xNode;if(i.trackable=n.trackable(),i.zLevel=f._getZLevel(e,t),i.isIgnored||!i.isVisible)return!1;var r=function(e){try{var t=s(e);return t[t.length-1]}catch(e){return}}(n.trackNodes())||{};if(i.index=r.index,"IN_SHOW"===i.viewStatus&&i.trackable){var o=f._getGioHybridNodeInfo(n,t);Y.push(o)}else"IN_COVERED"===i.viewStatus&&i.isContainer&&(o=f._getGioHybridNodeInfo(n,t),Y.push(o));if(z(e)||i.isContainer&&j(e))return!1;l(H(e))||f._getTrackElements(e,i)}))},this._getZLevel=function(e,t){var n=window.getComputedStyle(e),i=n.position,r=n.zIndex;if("auto"!==r)return Number(r||"0")+t.zLevel;switch(i){case"relative":return t.zLevel+2;case"sticky":return t.zLevel+3;case"absolute":return t.zLevel+4;case"fixed":return t.zLevel+5;default:return t.zLevel+1}},this._getGioHybridNodeInfo=function(e,n){var i=e.xNode,r=i.rect,o=i.tagName,a=i.zLevel,u=e.getGioNodeInfo(i),c=u.hyperlink,s=u.triggerEvent;return t(t(t({},r),u),{zLevel:a+f.deviceInfo.webviewZLevel,href:c,parentXPath:n.trackable?e.computeXpath(n).xpath:void 0,nodeType:"VIEW_CHANGE"===s?"INPUT_BTN":o})},this.xpathThreshold=n,this.deviceInfo=(r=(i=e).webviewLeft,o=i.webviewTop,a=i.webviewWidth,u=i.webviewHeight,c=i.webviewZLevel,{winWidth:d=document.documentElement.clientWidth,winHeight:document.documentElement.clientHeight,scale:a/d,webviewTop:o,webviewLeft:r,webviewWidth:a,webviewHeight:u,webviewZLevel:c})};export{q as GioHybridNode,K as GioWebNode};
