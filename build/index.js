import e from"array-from";var t=function(){return t=Object.assign||function(e){for(var t,n=1,i=arguments.length;i>n;n++)for(var r in t=arguments[n])({}).hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},t.apply(this,arguments)};function n(e,t,n){if(n||2===arguments.length)for(var i,r=0,o=t.length;o>r;r++)!i&&r in t||(i||(i=[].slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||[].slice.call(t))}var i=function(e){try{return e()}catch(e){return}},r=function(e){return"number"===g(e)},o=function(e){return"object"===g(e)&&!function(e){return s(["undefined","null"],g(e))}(e)},a=function(e){return Array.isArray(e)&&"array"===g(e)},u=function(e,t){var n=-1;if(a(e))for(var i=0;i<e.length;i++)if(t(e[i]))return i;return n},s=function(e,t){return("array"===g(e)||"string"===g(e))&&e.indexOf(t)>=0},c=e,l=function(e){return o(e)?Object.keys(e):[]},d=function(e){return a(e)?0===e.length:o(e)?0===l(e).length:!e},f=function(e){if(a(e)){for(var t=0,n=[],i=0,r=e;i<r.length;i++){var o=r[i];o&&!d(o)&&(n[t++]=o)}return n}return e},g=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},h=["body","br","canvas","clippath","defs","desc","g","hr","html","iframe","math","param","path","rect","script","style","text","title","tspan","use"],v=["button","reset","submit"],p=n(n([],v,!0),["file"],!1),N=["checkbox","color","radio","range"],m=n(n([],N,!0),["date","datetime-local","month","number","password","text","time","week"],!1),w=["tr","li","dt","dd"],L=n(["a","button","dl"],w,!0),b=["i","em","svg","img"],x=["i","span","em","b","strong","bdo"],E=/(^| |[^ ]+\-)(clear|clearfix|active|hover|enabled|current|selected|unselected|hidden|display|focus|disabled|undisabled|open|checked|unchecked|undefined|null|ng-|growing-)[^\. ]*/g,y=/^([a-zA-Z\-\_0-9]+)$/,_="data-growing-ignore",I="data-growing-container",C="data-growing-index",k="data-growing-title",T=function(e,t){var n;return null!==(n=i((function(){return e.hasAttribute(t)&&"false"!==e.getAttribute(t)})))&&void 0!==n?n:i((function(){return e.hasOwnPerporty(t)}))},S=function(e,t){var n;return null!==(n=i((function(){return e.getAttribute(t)})))&&void 0!==n?n:i((function(){return e.attributes[t].value}))},P=function(e){var t,n=!s(h,e.tagName.toLowerCase()),i=X(e);return n&&i&&s(x,null===(t=e.tagName)||void 0===t?void 0:t.toLowerCase())?P(i):e},O=function(e,t,n){if(void 0===t&&(t=5),void 0===n&&(n=0),!e.children)return!1;if("svg"===e.tagName.toLocaleLowerCase())return n>t;if(n>t)return!0;for(var i=0;i<e.children.length;i++){var r=e.children[i];if(O(r,t,n+1))return!0}return!1},D=function(e,t){var i=e.tagName.toLowerCase();if(!(e instanceof Element))return!1;if(T(e,_))return!1;if(s(h,i))return!1;if(s(["circleClick","circleHover","click"],t)){if("textarea"===i&&"click"===t)return!1;if("input"===i){if("click"===t&&!s(p,S(e,"type")))return!1;if(s(["circleClick","circleHover"],t)&&!s(n(n([],p,!0),m,!0),S(e,"type")))return!1}if(!j(e)&&O(e,5))return!1}return!0},H=function(e,t){return void 0===t&&(t=!1),c((null==e?void 0:e.childNodes)||[]).filter((function(e){return s(t?[Node.ELEMENT_NODE,Node.TEXT_NODE]:[Node.ELEMENT_NODE],e.nodeType)}))},X=function(e){return A(e.parentElement)?null:e.parentElement},A=function(e){return!e||s(["BODY","HTML","#document"],e.tagName)},j=function(e){return T(e,I)||s(L,e.tagName.toLowerCase())||"input"===e.tagName.toLowerCase()&&s(v,e.type)},z=function(e){var t=H(e);return!d(t)&&t.every((function(e){var t=B(e),n=s(e.classList,"icon");return!(!t&&!n||W(e))}))},W=function(e){var t=H(e,!0);return!d(t)&&t.every((function(e){var t=e.nodeType===Node.TEXT_NODE,n=G(e);return!(!t||!n)}))},B=function(e){return s(b,e.tagName.toLocaleLowerCase())},G=function(e){var t=H(e,!0).filter((function(e){var t;return e.nodeType===Node.TEXT_NODE||s(x,null===(t=e.tagName)||void 0===t?void 0:t.toLowerCase())})).map((function(e){return R(e.textContent,e.textContent.length)}));return R(f(t).join(" "))},R=function(e,t){return void 0===t&&(t=50),e&&(null==(e=e.replace(/[\n \t]+/g," ").trim())?void 0:e.length)?e.slice(0,r(t)&&t>0?t:void 0):""},U=/[^/]*.(bmp|jpg|jpeg|png|gif|svg|psd|webp|apng)/gi,F=function(e,t){switch(t){case"a":return function(e){if(T(e,"href")){var t=S(e,"href");if(t&&0!==t.indexOf("javascript"))return t.slice(0,320)}return""}(e);case"img":return function(e){var t=e.src;if(t&&-1===t.indexOf("data:image")){var n=t.match(U),i=d(n)?"":n[0];if(i.indexOf("%")>-1){var r=function(e,t){var n=-1;if(a(e))for(var i=0;i<e.length;i++)"%"===e[i]&&(n=i);return n}(i.split(""));i=i.substring(r+3,i.length)}return i}return""}(e);default:return""}},M={a:function(e){var t=G(e);return t||(Z(e)||F(e,"a"))},button:function(e){var t=S(e,"name");if(t)return t;var n=G(e);return n||(Z(e)||$(e))},img:function(e){return R(S(e,"alt"))||F(e,"img")},input:function(e){if("password"===e.type)return"";var t,n,i=e instanceof HTMLInputElement&&s(p,e.type),r=T(e,"data-growing-track");if(i||r)return R(e.value);if(e instanceof HTMLInputElement&&s(N,e.type)){var o=void 0;if(e.id)n=function(t){return t.htmlFor===e.id},o=(t=c(document.getElementsByTagName("label")))[u(t,n)];return o||(o=Y(e,(function(e){return"label"===e.tagName.toLowerCase()}))),K(e,o?G(o):R(e.value))}return""},label:function(e){var t=G(e);return t||(Z(e)||$(e))},select:function(e){return R(c(e.options).filter((function(e){return e.selected})).map((function(e){return e.label})).join(", ")||e.value)},svg:function(e){var t;return H(e).some((function(e){var n;if(e.nodeType===Node.ELEMENT_NODE&&"use"===(null===(n=e.tagName)||void 0===n?void 0:n.toLowerCase())&&e.hasAttribute("xlink:href"))return t=e,!0})),t?t.getAttribute("xlink:href"):""},textarea:function(){return""},form:function(){return""}},V=function(e,t){if(T(e,k)&&S(e,k))return R(S(e,k));if(T(e,"title")&&S(e,"title"))return R(S(e,"title"));var n=M[t];if(n)return n(e);var i=G(e);return i?R(i):function(e){if("svg"===e.tagName)return!1;var t=H(e);return t.length>0&&t.every((function(e){return function(e){if("svg"===e.tagName)return!0;var t=H(e);if(d(t))return!0;var n=W(e);return!(!d(t)&&!n)}(e)}))}(e)&&!z(e)?R(Z(e)):z(e)?R($(e)):""},Y=function(e,t){for(var n=e.parentElement;n&&!A(n);){if(t(n))return n;n=n.parentElement}},Z=function(e){var t=H(e);return f(t.map((function(e){var t=G(e);if(W(e)&&t)return t}))).join(" ")},$=function(e){var t;return H(e).some((function(e){var n,i=V(e,null===(n=e.tagName)||void 0===n?void 0:n.toLowerCase());return!!i&&(t=i,!0)})),t},K=function(e,t){return s(["checkbox","radio"],e.type)?"".concat(t).concat((n=e.checked,"boolean"===g(n)?"("+e.checked+")":"")):t;var n},q=function e(t,r,o,a,l){void 0===a&&(a=!0),void 0===l&&(l=[]);var f=this;this.originNode=t,this.deviceInfo=r,this.actionType=o,this.trackable=a,this.parentNodes=l,this._getIndex=function(){if(T(f.originNode,C)){var e=S(f.originNode,C);return/^\d{1,10}$/.test(e)&&e-0>0&&2147483647>e-0?+e:void(0>f.actionType.indexOf("circle")&&(l="".concat(e,"，index标记应为 大于 0 且小于 2147483647 的整数！"),"warn",console.log("%c [GrowingIO]：".concat(l),"color: #F59E0B;")))}if(s(["dd","dt"],f.tagName)){var t=X(f.originNode),i=t?H(t):[];if("dl"===t.tagName.toLowerCase()&&i.length>0){if("dd"===f.tagName){var r=u(i,(function(e){return e.isSameNode(f.originNode)}));if(r>-1)return(o=i.slice(0,r).filter((function(e){return"dt"===e.tagName.toLowerCase()}))).length-1+1}if("dt"===f.tagName){var o=i.filter((function(e){return"dt"===e.tagName.toLowerCase()}));return u(o,(function(e){return e.isSameNode(f.originNode)}))+1}}}if(f.isPureList){var a=u(f._pureList,(function(e){return e.isSameNode(f.originNode)}));return a>-1?(f.peerNodes=n([],f._pureList,!0),f.peerNodes.splice(a,1),a+1):void 0}if(f.isPseudoList){var c=u(f._pseudoList,(function(e){return e.isSameNode(f.originNode)}));return c>-1?(f.peerNodes=n([],f._pseudoList,!0),f.peerNodes.splice(c,1),c+1):void 0}var l},this._getSiblingNode=function(e,t){var n,r=X(e);if(!r)return[];for(var o=null!==(n=i((function(){return c(r.children)})))&&void 0!==n?n:[],a=[],u=0;u<o.length;u++){var s=o[u],l=o[u+1];if(!l||!t(s,l))break;d(a)?a.push(s,l):a.push(l)}return a},this._getIsPureList=function(){var e=f._getSiblingNode(f.originNode,(function(e,t){return e.tagName===t.tagName}));return!(1>e.length||!s(w,f.tagName)||(f._pureList=e,0))},this._getIsInPseudoList=function(){if(s(["th","td"],f.tagName))return!1;var e=f._getSiblingNode(f.originNode,(function(e,t){var n=e.tagName===t.tagName&&e.className===t.className,i=H(e),r=H(t),o=i.every((function(e,t){var n,i;return(null==e?void 0:e.tagName)===(null===(n=r[t])||void 0===n?void 0:n.tagName)&&(null==e?void 0:e.className)===(null===(i=r[t])||void 0===i?void 0:i.className)})),a=i.length===r.length&&o;return n&&a}));return e.length>=3&&(f._pseudoList=e,!0)},this._getClassList=function(e){var t;if(T(e,"name")&&S(e,"name"))return[S(e,"name")];var n=(null!==(t=S(e,"class"))&&void 0!==t?t:"").trim().split(" ");return d(n)?[]:n.filter((function(e){return e&&!E.test(e)&&y.test(e)})).sort()},this._getCurrentXpath=function(){return"/".concat(f.tagName).concat(f.id?"#"+f.id:"").concat(d(f.classList)?"":"."+f.classList.join("."))},this._getIsContainer=function(){return T(f.originNode,I)||s(L,f.tagName)||"input"===f.tagName&&s(v,f.originNode.type)},this._getContent=function(){f.content=V(f.originNode,f.tagName)},this._getIsOutFlow=function(){var e=window.getComputedStyle(f.originNode).position;return s(["fixed","sticky"],e)},this._getRect=function(){var e=f.originNode.getBoundingClientRect(),t=e.top,n=e.bottom,i=e.left,r=e.right-i,o=n-t,a=f.deviceInfo,u=a.winHeight,s=a.winWidth;return t+o>u&&(o=u-t),i+r>s&&(r=s-i),{top:t,left:i,width:r,height:o}},this._getListItemViewStatus=function(){var e=f.parentNodes.find((function(e){var t=e.originNode.scrollHeight,n=e.originNode.scrollWidth,i=e.rect,r=i.width;return t>i.height||n>r}));if(e){var t=e.rect,n=t.top,i=t.left,r=t.width,o=t.height,a=f.rect,u=a.top,s=a.left,c=a.width,l=a.height;return n>u+l||s>i+r||u>n+o||i>s+c?"OUTSIDE":u>=n&&s>=i&&n+o>u+l&&i+r>s+c?"DISPLAYED":"OBSCURED"}return""},this._getViewStatus=function(e){var t=window.getComputedStyle(f.originNode),i=t.opacity,r=t.visibility,o=t.display,a=t.width,u=t.height,c=f.rect,l=c.top,d=c.left,g=c.width,h=c.height,v=f.deviceInfo,p=v.winWidth,N=v.winHeight;if(0===Number(i)||"hidden"===r||"none"===o||"0px"===a||0===f.originNode.clientWidth||"0px"===u||0===f.originNode.clientHeight)return"HIDDEN";var m=n([],e,!0).find((function(e){return e.trackable&&s(["DISPLAYED","OBSCURED"],e.viewStatus)}));if(f.isPureList||f.isPseudoList){var w=f._getListItemViewStatus();if(w)return w}if(m)return m.viewStatus;var L=function(e,t){return document.elementFromPoint(e,t)===f.originNode};return N>l&&p>d&&g>0&&h>0?L(d+g/2,l+h/2)||L(d+1,l+1)||L(d+g-1,l+1)||L(d+1,l+h-1)||L(d+g-1,l+h-1)?"DISPLAYED":0>l+h||0>d+g?"OUTSIDE":"OBSCURED":"OUTSIDE"},this._getTriggerEvent=function(){return"input"===f.tagName&&s(m,f.originNode.type)||s(["select","textarea"],f.tagName)?"VIEW_CHANGE":"VIEW_CLICK"},this._getXParents=function(t,n){var i=t.parentElement,r=[];if(n.length>0)r.push.apply(r,n);else if(i&&!A(i)){var o=new e(i,void 0,f.actionType,D(i,f.actionType));r.push(o),o.xParents&&r.push.apply(r,o.xParents)}return r},this.tagName=t.tagName.toLocaleLowerCase(),this.classList=this._getClassList(t),this.id=t.id,this.currentXpath=this._getCurrentXpath(),this.isIgnored=T(this.originNode,_),this.isContainer=this._getIsContainer(),this.isPureList=this._getIsPureList(),this.isPseudoList=this._getIsInPseudoList(),this.index=this._getIndex(),this.hyperlink=F(t,this.tagName),this.content=V(this.originNode,this.tagName),this.triggerEvent=this._getTriggerEvent(),this.isOutFlow=this._getIsOutFlow(),r&&(this.rect=this._getRect(),this.viewStatus=this._getViewStatus(l)),this.xParents=this._getXParents(t,l)},J=function e(t,n,i,o,a){var u=this;this.origin=t,this.action=n,this.lengthThreshold=i,this.deviceInfo=o,this.parentNode=a,this.trackNodes=function(){var e;if(!u.trackable)return[];var t=[u.xNode];if(s(["click","circleClick","change"],u.actionType))for(var n=u._getParent();n;){if(!(null==n?void 0:n.xNode)||(null===(e=n.xNode)||void 0===e?void 0:e.isIgnored))return[];n.trackable&&t.push(n.xNode),n=n._getParent()}var i,o=[];return t.reverse().forEach((function(e,n){if(T(e.originNode,I)&&(o=[],i=void 0),r(e.index)&&!r(i)&&(i=e.index),r(i)&&(e.index=i),n===t.length-1)o.push(u.getGioNodeInfo(e));else{var a=e.isPureList||e.isPseudoList;(e.isContainer||a)&&o.push(u.getGioNodeInfo(e))}})),o},this.getGioNodeInfo=function(e){var t=u.computeXpath(e),n=t.skeleton,i=t.fullXpath,r=t.xcontent,o=e.hyperlink,a=e.index,s=e.peerNodes,c=e.content,l=e.triggerEvent,d=e.originNode;return{skeleton:n,xpath:n,fullXpath:i,xcontent:r,hyperlink:o,index:a,peerNodes:null!=s?s:[],content:R(c),triggerEvent:l,originNode:d}},this.computeXpath=function(e){var t,n="/"+e.tagName,i=e.currentXpath,r="/"+((e.id?"#"+e.id:"")+(d(e.classList)?"":"."+e.classList.join("."))||"-");return null===(t=e.xParents)||void 0===t||t.forEach((function(e,t){if(i=e.currentXpath+i,t<u.xpathThreshold-1){n="/"+e.tagName+n;var o=(e.id?"#"+e.id:"")+(d(e.classList)?"":"."+e.classList.join("."));r="/"+(o||"-")+r}})),{skeleton:n,fullXpath:i,xcontent:r}},this._getParent=function(){var t=X(u.originElement);if(t&&t.nodeName&&!A(t))return new e(t,u.actionType)},this.actionType=s(["circleClick","circleHover","click","change"],n)?n:"click",this.originElement=P(t),this.xpathThreshold=r(i)?i:4,this.trackable=D(this.originElement,this.actionType),this.originElement.isSameNode(t)||(a=null);var c=[];a&&a.xNode&&(c.push(a.xNode),a.xNode.xParents&&c.push.apply(c,a.xNode.xParents)),this.xNode=new q(this.originElement,this.deviceInfo,this.actionType,this.trackable,c)},Q=[],ee=function(e,n){var i,r,o,a,u,c,f,g=this;this.trackNodes=function(e,t,n){return void 0===n&&(n=!1),Q=[],g._getTrackElements(e,t,null,n),Q},this._getTrackElements=function(e,t,n,i){void 0===i&&(i=!1),H(e).forEach((function(e){var r,o,a,u;if(!(null==e?void 0:e.tagName)||s(["circle-shape","circle-page","heatmap-page"],null===(r=null==e?void 0:e.tagName)||void 0===r?void 0:r.toLowerCase())||(null===(o=null==e?void 0:e.id)||void 0===o?void 0:o.indexOf("__vconsole"))>-1||(null===(a=null==e?void 0:e.id)||void 0===a?void 0:a.indexOf("__giokit"))>-1)return!1;var c=new J(e,"circleClick",g.xpathThreshold,g.deviceInfo,n),l=c.xNode;if(l.zLevel=g._getZLevel(e,t),c.trackable&&(s(["DISPLAYED","OBSCURED"],l.viewStatus)||i)){if(t.index&&(l.index=t.index),Q.find((function(e){return e.originNode.isSameNode(l.originNode)})))return!1;if("DISPLAYED"===l.viewStatus){var f=g._getGioHybridNodeInfo(c,t);Q.push(f)}else"OBSCURED"===l.viewStatus&&(l.isContainer||i)&&(f=g._getGioHybridNodeInfo(c,t),Q.push(f));if(B(e)||l.isContainer&&W(e))return!1}d(H(e))||g._getTrackElements(e,null!==(u=c.xNode)&&void 0!==u?u:t,c,i)}))},this._getZLevel=function(e,t){var n=window.getComputedStyle(e),i=n.position,r=n.zIndex;if("auto"!==r){var o=Number(r||0);return(Number.isNaN(o)?0:o)+t.zLevel}switch(i){case"relative":return t.zLevel+2;case"sticky":return t.zLevel+3;case"absolute":return t.zLevel+4;case"fixed":return t.zLevel+5;default:return t.zLevel+1}},this._getGioHybridNodeInfo=function(e,n){var i=e.xNode,r=i.rect,o=i.zLevel,a=e.getGioNodeInfo(i),u=a.hyperlink,s={};return l(r).forEach((function(e){return s[e]=r[e]*g.deviceInfo.scale})),s.top+=g.deviceInfo.webviewTop,s.left+=g.deviceInfo.webviewLeft,t(t(t({},s),a),{zLevel:o+g.deviceInfo.webviewZLevel,href:u,parentXPath:n.trackable?e.computeXpath(n).xpath:void 0})},this.xpathThreshold=n,this.deviceInfo=(r=(i=e).webviewLeft,o=i.webviewTop,a=i.webviewWidth,u=i.webviewHeight,c=i.webviewZLevel,f=a/window.innerWidth,{winWidth:window.innerWidth,winHeight:window.innerHeight,scale:f,webviewTop:o,webviewLeft:r,webviewWidth:a,webviewHeight:u,webviewZLevel:c})};export{ee as GioHybridNode,J as GioWebNode};
