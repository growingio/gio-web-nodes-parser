import e from"array-from";import t from"nice-try";var n=function(){return n=Object.assign||function(e){for(var t,n=1,i=arguments.length;i>n;n++)for(var r in t=arguments[n])({}).hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};function i(e,t,n){if(n||2===arguments.length)for(var i,r=0,o=t.length;o>r;r++)!i&&r in t||(i||(i=[].slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||[].slice.call(t))}var r=function(e){return"number"===d(e)},o=function(e){return"object"===d(e)&&!function(e){return s(["undefined","null"],d(e))}(e)},a=function(e){return Array.isArray(e)&&"array"===d(e)},u=function(e,t){var n=-1;if(a(e))for(var i=0;i<e.length;i++)if(t(e[i]))return i;return n},s=function(e,t){return("array"===d(e)||"string"===d(e))&&e.indexOf(t)>=0},c=e,l=function(e){return a(e)?0===e.length:o(e)?0===function(e){return o(e)?Object.keys(e):[]}(e).length:!e},d=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},f=["bdo","body","br","canvas","clippath","defs","desc","g","hr","html","iframe","math","param","path","rect","text","title","tspan","use"],h=["button","reset","submit"],g=i(i([],h,!0),["file"],!1),v=["checkbox","color","date","datetime-local","month","radio","range","time","week"],m=i(i([],v,!0),["text"],!1),N=["tr","li","dl"],p=i(["a","button"],N,!0),w=["i","em","svg","img"],L=/(^| |[^ ]+\-)(clear|clearfix|active|hover|enabled|current|selected|unselected|hidden|display|focus|disabled|undisabled|open|checked|unchecked|undefined|null|ng-|growing-)[^\. ]*/g,E=/^([a-zA-Z\-\_0-9]+)$/,_="data-growing-ignore",b="data-growing-index",x="data-growing-title",C=function(e,n){var i;return null!==(i=t((function(){return e.hasAttribute(n)&&"false"!==e.getAttribute(n)})))&&void 0!==i?i:t((function(){return e.hasOwnPerporty(n)}))},y=function(e,n){var i;return null!==(i=t((function(){return e.getAttribute(n)})))&&void 0!==i?i:t((function(){return e.attributes[n].value}))},I=function(e){var t,n,i=!s(f,e.nodeName.toLowerCase()),r=O(e);return i?r&&("button"===(null===(n=(t=r).tagName)||void 0===n?void 0:n.toLowerCase())&&X(t)||X(r))?I(r):e:r?I(r):e},T=function(e,t,n){if(void 0===t&&(t=5),void 0===n&&(n=0),!e.children)return!1;if("svg"===e.tagName.toLocaleLowerCase())return n>t;if(n>t)return!0;for(var i=0;i<e.children.length;i++){var r=e.children[i];if(T(r,t,n+1))return!0}return!1},k=function(e){return c((null==e?void 0:e.childNodes)||[]).filter((function(e){return e instanceof Element}))},O=function(e){return P(e.parentElement)?null:e.parentElement},P=function(e){return!e||s(["BODY","HTML","#document"],e.tagName)},H=function(e){if(!e.children)return!1;for(var t=0;t<e.children.length;t++){var n=e.children[t],i=s(w,n.tagName.toLocaleLowerCase()),r=n.classList.contains("icon");if(!i||!r)return!1;if(0!==n.childNodes.length&&""!==n.textContent.trim())return!1}return!0},X=function(e){for(var t=e.childNodes,n=0;n<t.length;n++){var i=t[n];if(i.nodeType!==Node.TEXT_NODE)return!1;if(0===i.textContent.trim().length)return!1}return!0},S=function(e){if("svg"===e.tagName)return!0;if(!e.children)return!0;for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!==Node.COMMENT_NODE&&(n.nodeType!==Node.TEXT_NODE||!/^\s*$/.test(n.textContent)))return!1}return!0},W=function(e,t){return void 0===t&&(t=50),e&&(null==(e=e.replace(/[\n \t]+/g," ").trim())?void 0:e.length)?e.slice(0,r(t)&&t>0?t:void 0):""},z=function(e,t){switch(t){case"a":return function(e){if(C(e,"href")){var t=y(e,"href");if(t&&0!==t.indexOf("javascript"))return t.slice(0,320)}return""}(e);case"img":return function(e){var t;if(e.src&&-1===e.src.indexOf("data:image")){var n=(null!==(t=e.src.split("?")[0])&&void 0!==t?t:"").split("/");return n.length>1?n[n.length-1]:""}return""}(e);default:return""}},V={a:function(e){if((S(e)||(i=w,(n=e).hasChildNodes()&&!c(n.children).some((function(e){return s(i,e.tagName)}))))&&e.textContent){var t=W(e.textContent);if(t)return t}var n,i;return z(e,"a")},button:function(e){var t=y(e,"name");return t||(W(e.textContent)||F(e))},img:function(e){return W(y(e,"alt"))||z(e,"img")},input:function(e){var t,n,i=e instanceof HTMLInputElement&&s(g,e.type),r=C(e,"data-growing-track")&&"password"!==e.type;if(i||r)return W(e.value);if(e instanceof HTMLInputElement&&s(v,e.type)){var o=void 0;if(e.id)n=function(t){return y(t,"for")===e.id||t.htmlFor===e.id},o=(t=document.getElementsByTagName("label"))[u(t,n)];else o=G(e,(function(e){return"label"===e.tagName}));if(o){var a=W(o.textContent);return"".concat(a,"(").concat(function(e){return"boolean"===d(e)}(e.checked)?e.checked:W(e.value),")")}return W(e.value)}return""},label:function(e){return W(e.textContent)||""},select:function(e){return W(c(e.options).filter((function(e){return e.selected})).map((function(e){return e.label})).join(", ")||e.value)},svg:function(e){var t;return c(e.childNodes).some((function(e){if(e.nodeType===Node.ELEMENT_NODE&&"use"===e.tagName.toLowerCase()&&e.hasAttribute("xlink:href"))return t=e,!0})),t?t.getAttribute("xlink:href"):""},textarea:function(){return""},form:function(){return""}},A=function(e,t,n){if(C(e,x)&&y(e,x))return W(y(e,x));if(C(e,"title")&&y(e,"title"))return W(y(e,"title"));var i=V[t];return i?i(e):S(e)?D(e):function(e){return!(!e.hasChildNodes()||"svg"===e.nodeName)&&0===c(e.childNodes).filter((function(e){return!S(e)})).length}(e)&&!H(e)?j(e):n.isContainer||H(e)?F(e):""},G=function(e,t){for(var n=e.parentElement;n&&!P(n);){if(t(n))return n;n=n.parentElement}},D=function(e){var t=W(e.textContent);if(t)return t},j=function(e){var t="";return c(e.childNodes).forEach((function(e){e.nodeType===Node.TEXT_NODE&&e.textContent&&(t=e.textContent.trim()+" ")})),W(t)},F=function(e){var t;return c(e.childNodes).filter((function(e){return 1===e.nodeType})).some((function(e){var n=W(e.textContent);if(e.nodeType===Node.TEXT_NODE&&n)return t=n,!0;if(e.textContent&&!n)return!1;var i=A(e,e.tagName.toLowerCase(),new M(e));return!!i&&(t=i,!0)})),W(t)},M=function(e,r){var o=this;this.originNode=e,this.deviceInfo=r,this._getIndex=function(){if(C(o.originNode,b)){var e=y(o.originNode,b);return/^\d{1,10}$/.test(e)&&+e>=0&&2147483647>+e?+e:("warn",void console.log("%c [GrowingIO]：".concat("".concat(e,"，index标记应为 大于等于 0 且小于 2147483647 的整数！")),"color: #F59E0B;"))}if(o.isPureList){var t=u(o._pureList,(function(e){return e.isSameNode(o.originNode)}));return t>-1?(o.peerNodes=i([],o._pureList,!0),o.peerNodes.splice(t,1),t):void 0}if(o.isPseudoList){var n=u(o._pseudoList,(function(e){return e.isSameNode(o.originNode)}));return n>-1?(o.peerNodes=i([],o._pseudoList,!0),o.peerNodes.splice(n,1),n):void 0}},this._getSiblingNode=function(e,n){var i,r=O(e);return r?(null!==(i=t((function(){return c(r.children)})))&&void 0!==i?i:[]).filter((function(t){return n(t,e)})):[]},this._getIsPureList=function(){var e=o._getSiblingNode(o.originNode,(function(e,t){return e.tagName===t.tagName}));return!(1>e.length||!s(N,o.tagName)||(o._pureList=e,0))},this._getIsInPseudoList=function(){if(s(["th","td"],o.tagName))return!1;var e=o._getSiblingNode(o.originNode,(function(e,t){var n=e.tagName===t.tagName&&e.className===t.className,i=k(e),r=k(t),o=i.every((function(e,t){var n,i;return(null==e?void 0:e.tagName)===(null===(n=r[t])||void 0===n?void 0:n.tagName)&&(null==e?void 0:e.className)===(null===(i=r[t])||void 0===i?void 0:i.className)})),a=i.length===r.length&&o;return n&&a}));return e.length>=3&&(o._pseudoList=e,!0)},this._getClassList=function(e){var t;if(C(e,"name")&&y(e,"name"))return[y(e,"name")];var n=(null!==(t=y(e,"class"))&&void 0!==t?t:"").trim().split(" ");return l(n)?[]:n.filter((function(e){return e&&!L.test(e)&&E.test(e)})).sort()},this._getCurrentXpath=function(){return"/".concat(o.tagName).concat(o.id?"#"+o.id:"").concat(l(o.classList)?"":"."+o.classList.join("."))},this._getIsContainer=function(){return C(o.originNode,"data-growing-container")||s(p,o.tagName)||"input"===o.tagName&&s(h,o.originNode.type)},this._getContent=function(){o.content=A(o.originNode,o.tagName,n({},o))},this._getIsOutFlow=function(){var e=window.getComputedStyle(o.originNode).position;return s(["fixed","sticky"],e)},this._getIsVisible=function(){var e=window.getComputedStyle(o.originNode),t=e.opacity,n=e.visibility,i=e.display;return Number(t)>0&&"hidden"!==n&&"none"!==i&&(o.originNode.clientHeight>0||o.originNode.clientWidth>0)},this._getRect=function(){var e=o.originNode.getBoundingClientRect(),t=e.top,n=e.bottom,i=e.left,r=e.right-i,a=n-t;return 0>t?a=t+a:t+a>o.deviceInfo.winHeight&&(a=o.deviceInfo.winHeight-t),0>i?r=i+r:i+r>o.deviceInfo.winWidth&&(r=o.deviceInfo.winWidth-i),{top:t,left:i,width:r,height:a}},this._getViewStatus=function(){var e=o.rect,t=e.top,n=e.left,i=e.width,r=e.height,a=o.deviceInfo,u=a.winWidth,s=function(e,t){return document.elementFromPoint(e,t)===o.originNode};return a.winHeight>t&&u>n&&i>0&&r>0?s(n+i/2,t+r/2)||s(n+1,t+1)||s(n+i-1,t+1)||s(n+1,t+r-1)||s(n+i-1,t+r-1)?"IN_SHOW":"IN_COVERED":"OUT"},this._getTriggerEvent=function(){return"input"===o.tagName&&s(m,o.originNode.type)||s(["select","textarea"],o.tagName)?"VIEW_CHANGE":"VIEW_CLICK"},this.tagName=e.tagName.toLocaleLowerCase(),this.isPureList=this._getIsPureList(),this.isPseudoList=this._getIsInPseudoList(),this.isContainer=this._getIsContainer(),this.classList=this._getClassList(e),this.index=this._getIndex(),this.id=e.id,this.triggerEvent=this._getTriggerEvent(),this.hyperlink=z(e,this.tagName),this.currentXpath=this._getCurrentXpath(),this.isIgnored=C(this.originNode,_),this.content=A(this.originNode,this.tagName,this),this.isOutFlow=this._getIsOutFlow(),this.isVisible=this._getIsVisible(),r&&(this.rect=this._getRect(),this.viewStatus=this._getViewStatus())},Z=function e(t,n,o,a){var u=this;this.origin=t,this.action=n,this.lengthThreshold=o,this.deviceInfo=a,this.trackable=function(){var e=u.originElement.tagName.toLowerCase();if(!(u.originElement instanceof Element))return!1;if(C(u.originElement,_))return!1;if(s(f,e))return!1;if(s(["circleClick","circleHover","click"],u.actionType)){if("textarea"===e&&"click"===u.actionType)return!1;if("input"===e){if("click"===u.actionType&&!s(g,y(u.originElement,"type")))return!1;if(s(["circleClick","circleHover"],u.actionType)&&!s(i(i([],g,!0),m,!0),y(u.originElement,"type")))return!1}if(!u.xNode.isContainer&&T(u.originElement,5))return!1}return!0},this.trackNodes=function(){if(!u.trackable())return[];var e=[u.xNode];if("click"===u.actionType)for(var t=u._getParent();t;){if(t.xNode.isIgnored)return[];t.trackable()&&e.push(t.xNode),t=t._getParent()}var n=[];return e.some((function(t,i){if(t.xParents=u.getXParents(t.originNode),0!==i){var r=t.isPureList||t.isPseudoList;return!(!t.isContainer&&!r||(n.push(u.getGioNodeInfo(t)),0))}if(n.push(u.getGioNodeInfo(t)),t.isContainer&&e.length>=5)return!1})),n.reverse()},this.getGioNodeInfo=function(e){var t=u.computeXpath(e),n=t.skeleton,i=t.fullXpath,r=t.xpath,o=t.xcontent,a=e.hyperlink,s=e.index,c=e.peerNodes;return{skeleton:n,fullXpath:i,xpath:r,xcontent:o,hyperlink:a,index:s,peerNodes:null!=c?c:[],content:e.content,outFlow:e.isOutFlow,triggerEvent:e.triggerEvent}},this.computeXpath=function(e){var t="/"+e.tagName,n=e.currentXpath,i=e.currentXpath,r="/"+((e.id?"#"+e.id:"")+(l(e.classList)?"":"."+e.classList.join("."))||"-");return e.xParents.forEach((function(e,o){if(n=e.currentXpath+n,o<u.xpathThreshold-1){t="/"+e.tagName+t,i=e.currentXpath+i;var a=(e.id?"#"+e.id:"")+(l(e.classList)?"":"."+e.classList.join("."));r="/"+(a||"-")+r}})),{skeleton:t,fullXpath:n,xpath:i,xcontent:r}},this._getParent=function(){var t=O(u.originElement);if(t&&t.nodeName&&!P(t))return new e(t,u.actionType)},this.getXParents=function(e){for(var t=e.parentElement,n=[];t&&!P(t);)n.push(new M(t)),t=t.parentElement;return n},this.actionType=s(["circleClick","circleHover","click","change"],n)?n:"click",this.originElement=I(t),this.xpathThreshold=r(o)?o:4,this.originElement&&(this.xNode=new M(this.originElement,this.deviceInfo))},B=[],R=function(e,t){var i,r,o,a,u,c,d,f=this;this.trackNodes=function(e,t){return B=[],f._getTrackElements(e,t),B},this._getTrackElements=function(e,t){k(e).filter((function(e){return 1===e.nodeType})).forEach((function(n){var i=new Z(n,"",f.xpathThreshold,f.deviceInfo),r=i.xNode;if(r.zLevel=f._getZLevel(n,t),r.isIgnored||!r.isVisible)return!1;if(r.xParents=i.getXParents(e),"IN_SHOW"===r.viewStatus&&i.trackable()){var o=f._getGioHybridNodeInfo(i,t);B.push(o)}else"IN_COVERED"===r.viewStatus&&r.isContainer&&(o=f._getGioHybridNodeInfo(i,t),B.push(o));if(s(w,n.tagName.toLocaleLowerCase())||r.isContainer&&X(n))return!1;l(k(n))||f._getTrackElements(n,r)}))},this._getZLevel=function(e,t){var n=window.getComputedStyle(e),i=n.position,r=n.zIndex;if("auto"!==r)return Number(r||"0")+t.zLevel;switch(i){case"relative":return t.zLevel+2;case"sticky":return t.zLevel+3;case"absolute":return t.zLevel+4;case"fixed":return t.zLevel+5;default:return t.zLevel+1}},this._getGioHybridNodeInfo=function(e,t){var i=e.xNode,r=i.rect,o=i.tagName,a=i.zLevel,u=e.getGioNodeInfo(i),s=u.hyperlink,c=u.triggerEvent;return n(n(n({},r),u),{zLevel:a+f.deviceInfo.webviewZLevel,href:s,parentXPath:t.isContainer?e.computeXpath(t).xpath:void 0,nodeType:"VIEW_CHANGE"===c?"INPUT_BTN":o})},this.xpathThreshold=t,this.deviceInfo=(r=(i=e).webviewLeft,o=i.webviewTop,a=i.webviewWidth,u=i.webviewHeight,c=i.webviewZLevel,{winWidth:d=document.documentElement.clientWidth,winHeight:document.documentElement.clientHeight,scale:a/d,webviewTop:o,webviewLeft:r,webviewWidth:a,webviewHeight:u,webviewZLevel:c})};export{R as GioHybridNode,Z as GioWebNode};
